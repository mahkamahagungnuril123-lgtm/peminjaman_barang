<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Informasi Peminjaman Barang - MS Redelong</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <style>
        :root {
            --bg-login-url: url('background.jpg'); 
            --bg-app-new-url: url('https://images.unsplash.com/photo-1553095066-5014bc7b7f2d?q=80&w=2071&auto=format&fit=crop');
            --bg-pegawai-url: url('https://images.unsplash.com/photo-1511447333015-45b65e60f6d5?q=80&w=1955&auto=format&fit=crop');
            --primary-color: #1a5c4a;
            --secondary-color: #f7b731;
            --danger-color: #dc3545;
            --info-color: #0d6efd;
            --success-color: #198754;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --white-color: #ffffff;
            --border-color: #dee2e6;
            --shadow: 0 10px 30px rgba(0,0,0,0.07);
        }
        *, *::before, *::after { box-sizing: border-box; }
        
        body {
            font-family: 'Poppins', sans-serif; margin: 0; color: #333;
            background-color: #212529; display: flex; justify-content: center;
            align-items: center; min-height: 100vh; overflow-y: auto; position: relative;
        }
        body::before {
            content: ''; position: fixed; top: -5%; left: -5%; width: 110%; height: 110%;
            z-index: -1; background-size: cover; background-position: center;
            background-attachment: fixed; background-image: linear-gradient(rgba(10, 20, 30, 0.6), rgba(10, 20, 30, 0.6)), var(--bg-login-url);
            filter: blur(5px); animation: kenBurnsEffect 40s ease-in-out infinite alternate;
        }
        @keyframes kenBurnsEffect { from { transform: scale(1); } to { transform: scale(1.15); } }
        
        body.app-active { align-items: flex-start; } 
        body.pegawai-active { align-items: center; } 
        
        body.app-active::before { background-image: linear-gradient(rgba(10, 20, 30, 0.5), rgba(10, 20, 30, 0.6)), var(--bg-app-new-url); filter: blur(3px); }
        body.pegawai-active::before { background-image: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.5)), var(--bg-pegawai-url); filter: blur(3px); }

        .glass-card { background: rgba(20, 25, 40, 0.65); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 15px 35px rgba(0,0,0,0.25); border-radius: 16px; }
        .form-section input, .form-section select, .form-section button, .modal-content input, .modal-content select { background-color: rgba(0,0,0,0.25); border: 1px solid rgba(255, 255, 255, 0.3); color: var(--white-color); }
        .form-section input:focus, .form-section select:focus, .modal-content input:focus, .modal-content select:focus { outline: none; border-color: var(--secondary-color); box-shadow: 0 0 0 3px rgba(247, 183, 49, 0.25); }
        .photo-capture-area { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-top: 10px; width: 100%; }
        .photo-capture-area video, .photo-capture-area img { width: 100%; max-width: 400px; height: auto; max-height: 300px; object-fit: cover; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.3); background-color: rgba(0,0,0,0.2); }
        .photo-capture-area button { width: 100%; max-width: 400px; }
        .status-badge { padding: 8px 12px; border-radius: 20px; font-size: 13px; font-weight: 500; text-align: center; margin-top: 10px; border: 1px solid transparent; }
        .status-badge.success { background-color: rgba(25, 135, 84, 0.2); color: #75b798; border-color: #75b798; }
        .status-badge.error { background-color: rgba(220, 53, 69, 0.2); color: #f1aeb5; border-color: #f1aeb5; }
        .status-badge.warning { background-color: rgba(255, 193, 7, 0.2); color: #ffe69c; border-color: #ffe69c; }
        
        .hidden { display: none !important; }

        #login-view { width: 100%; max-width: 450px; text-align: center; background: rgba(10, 25, 40, 0.88); backdrop-filter: blur(10px); padding: 40px 35px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: var(--shadow); margin: 20px; }
        #login-view img.logo { width: 125px; height: 125px; object-fit: contain; margin-bottom: 15px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4)); }
        #login-view h1, #login-view p { color: var(--white-color); }
        #login-view h1 { font-weight: 600; font-size: 1.7em; margin-bottom: 8px; }
        #login-view p { opacity: 0.8; margin-bottom: 30px; }
        #login-form { display: flex; flex-direction: column; gap: 18px; }
        #login-form select, #login-form input { padding: 14px; border-radius: 8px; border: 1px solid #444; font-size: 16px; background-color: #2c3e50; color: var(--white-color); transition: border-color 0.3s, box-shadow 0.3s; }
        #login-form select:focus, #login-form input:focus { outline: none; border-color: var(--secondary-color); box-shadow: 0 0 0 3px rgba(247, 183, 49, 0.25); }
        
        /* === PERUBAHAN CSS: Menyesuaikan Tombol Login & Panduan === */
        #login-form button, #login-form .btn-panduan {
            display: block;
            width: 100%;
            box-sizing: border-box;
            padding: 14px;
            border-radius: 8px;
            border: 1px solid #444;
            font-size: 16px;
            font-weight: 600;
            background-color: #2c3e50;
            color: var(--white-color);
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
            text-decoration: none;
            text-align: center;
        }
        #login-form button:hover, #login-form .btn-panduan:hover,
        #login-form button:focus, #login-form .btn-panduan:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(247, 183, 49, 0.25);
        }
        
        #app-container { width: 100%; max-width: 1400px; padding: 25px; min-height: 90vh; display: flex; flex-direction: column; justify-content: flex-start; }
        body.app-active #app-container, body.pegawai-active #app-container { margin: 40px auto; }
        
        #app-container header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .app-logo { height: 45px; width: 45px; object-fit: contain; }
        #welcome-message { margin: 0; font-size: 1.4em; color: var(--white-color); }
        #logout-button { padding: 8px 16px; background-color: var(--danger-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background-color 0.3s; }
        
        #main-content { 
            flex-grow: 1; display: flex; flex-direction: column; width: 100%;
            justify-content: center; align-items: center;
        }
        #pegawai-dashboard, #peminjaman-form-view, #pengembalian-form-view {
            width: 100%; max-width: 950px;
        }
        
        #data-view {
            width: 100%;
            padding: 25px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            width: 100%;
            max-width: 800px;
            margin: 40px auto;
        }
        .dashboard-card {
            border-radius: 12px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s ease-out;
            background: rgba(20, 25, 40, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.1);
        }
        #show-pinjam-form-btn {
            border-image: linear-gradient(135deg, rgba(0,255,255,0.5), rgba(0,255,255,0.2)) 1;
        }
         #show-kembali-form-btn {
            border-image: linear-gradient(135deg, rgba(255,193,7,0.5), rgba(255,193,7,0.2)) 1;
        }
        .dashboard-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.15);
        }
        #show-pinjam-form-btn:hover {
            border-image: linear-gradient(135deg, rgba(0,255,255,1), rgba(0,255,255,0.4)) 1;
        }
        #show-kembali-form-btn:hover {
            border-image: linear-gradient(135deg, rgba(255,193,7,1), rgba(255,193,7,0.4)) 1;
        }
        .dashboard-card .icon {
            font-size: 32px;
            margin-bottom: 20px;
            text-align: left;
        }
        #show-pinjam-form-btn .icon {
            color: #00ffff;
        }
        #show-kembali-form-btn .icon {
            color: #FFC107;
        }
        .dashboard-card h3 {
            text-align: left;
            margin: 0;
            font-size: 1.5em;
            font-weight: 600;
            color: var(--white-color);
        }
        .dashboard-card p {
            text-align: left;
            opacity: 0.8;
            margin-top: 8px;
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.8);
        }

        .form-section { margin-bottom: 25px; padding: 20px 30px; }
        .form-section h3 { margin-top: 0; padding-bottom: 10px; margin-bottom: 20px; font-weight: 600; color: var(--white-color); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .form-grid input, .form-grid select, .form-grid button { width: 100%; padding: 12px; box-sizing: border-box; border-radius: 6px; font-size: 15px; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group label { font-weight: 500; font-size: 14px; color: rgba(255, 255, 255, 0.9); }
        .form-actions { grid-column: 1 / -1; display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .form-actions button { flex-grow: 1; padding: 12px; font-size: 16px; font-weight: 500; border: none; cursor: pointer; border-radius: 6px; transition: background-color 0.3s; min-width: 150px; }
        .btn-submit { background-color: var(--primary-color); color: var(--white-color); }
        .btn-back { background-color: #6c757d; color: var(--white-color); }
        
        #data-table-container { overflow-x: auto; max-height: 65vh; overflow-y: auto; position: relative; width: 100%; border-radius: 8px; }
        table { width: 100%; min-width: 1200px; border-collapse: collapse; color: #e0e0e0; }
        th, td { padding: 12px 15px; text-align: left; vertical-align: middle; font-size: 14px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
        th { position: sticky; top: 0; z-index: 10; background-color: rgba(30, 35, 50, 0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); color: var(--white-color); font-weight: 600; white-space: nowrap; }
        tbody tr:hover { background-color: rgba(255, 255, 255, 0.08); }
        td .table-photo { width: 70px; height: 70px; object-fit: cover; border-radius: 8px; cursor: pointer; transition: transform 0.2s; }
        td .table-photo:hover { transform: scale(3.5); z-index: 20; border: 2px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.2); position: relative; }
        
        /* === PERUBAHAN CSS: Perbaikan Kolom Aksi/ID === */
        td .actions { 
            display: flex; 
            flex-direction: column; 
            gap: 5px; 
            align-items: flex-start;
            margin-top: 5px; /* Memberi jarak antara ID dan tombol */
        }
        .actions button, .actions select { width: 100%; box-sizing: border-box; }
        .actions button { padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; color: white; font-size: 12px; font-weight: 500; }
        .actions select { padding: 5px; border-radius: 5px; font-size: 12px; transition: border-color 0.3s ease; }
        .btn-delete { background-color: var(--danger-color); }
        .btn-return { background-color: var(--success-color); }
        .actions select.rating-saving { border-color: #f7b731 !important; box-shadow: 0 0 5px #f7b731; }
        .actions select.rating-success { border-color: #198754 !important; }
        .actions select.rating-error { border-color: #dc3545 !important; }

        #pagination-controls { display: flex; justify-content: center; align-items: center; padding: 20px 0; gap: 8px; }
        .pagination-btn { background-color: rgba(0,0,0,0.25); border: 1px solid rgba(255, 255, 255, 0.3); color: var(--white-color); padding: 8px 14px; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .pagination-btn:hover { background-color: rgba(255, 255, 255, 0.15); }
        .pagination-btn.active { background-color: var(--secondary-color); color: var(--dark-color); border-color: var(--secondary-color); }
        .pagination-btn:disabled { background-color: rgba(0,0,0,0.1); color: rgba(255,255,255,0.4); cursor: not-allowed; }
        
        #filter-view { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 20px; width:100%; }
        #search-input { padding: 10px; border-radius: 6px; font-size: 15px; flex-grow: 1; min-width: 250px; }
        #pengawas-features { display: flex; gap: 10px; flex-wrap: wrap; }
        
        #pengawas-features .btn {
            padding: 10px 15px;
            border-radius: 6px;
            border: none;
            color: white;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            text-align: center;
            transition: opacity 0.3s, transform 0.2s;
        }
        #pengawas-features .btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }
        .btn-db { background-color: #0F9D58; } /* Google Sheets Green */
        .btn-drive { background-color: #FFBA00; color: var(--dark-color) !important; } /* Google Drive Yellow */
        .btn-info { background-color: var(--info-color); }
        .btn-primary { background-color: var(--primary-color); }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: rgba(30, 40, 60, 0.95); backdrop-filter: blur(10px); padding: 30px; border-radius: 12px; width: 95%; max-width: 500px; text-align: center; color: white; border: 1px solid rgba(255,255,255,0.2); }
        .modal-content h3 { margin-top: 0; }
        .modal-content form { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .modal-content .form-group { text-align: left; }
        .modal-content input, .modal-content select { padding: 12px; border-radius: 6px; font-size: 15px; width: 100%; }
        .modal-controls { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
        .modal-controls button { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; }
        
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(10, 20, 40, 0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; opacity: 0; transition: opacity 0.5s ease-in-out; pointer-events: none; }
        #loader-overlay:not(.hidden) { opacity: 1; pointer-events: auto; }
        .loader-content { text-align: center; color: var(--white-color); }
        .progress-bar-container { width: 300px; max-width: 80vw; height: 20px; background-color: rgba(0, 0, 0, 0.3); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.3); overflow: hidden; margin: 20px auto 0 auto; }
        .progress-bar-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #f7b731, #f8cf6a); border-radius: 10px; transition: width 0.4s ease-out; }
        #progress-text { font-size: 1.5em; font-weight: 600; margin-top: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        #progress-status-text { font-size: 1em; font-weight: 400; opacity: 0.8; margin-top: 5px; min-height: 1.2em; }
    </style>
</head>
<body>

    <div id="login-view">
        <img src="logo.jpg" alt="Logo MS Simpang Tiga Redelong" class="logo">
        <h1>Sistem Informasi Peminjaman Barang</h1>
        <p>Mahkamah Syar'iyah Simpang Tiga Redelong</p>
        <form id="login-form">
            <select id="role-selector" required><option value="">-- Pilih Status Anda --</option><option value="pengunjung">Pengunjung</option><option value="pegawai">Pegawai</option><option value="pengawas">Pengawas</option></select>
            <input type="password" id="password-input" placeholder="Masukkan Password" class="hidden" autocomplete="current-password">
            <button type="submit">Masuk</button>
            <a href="https://drive.google.com/drive/folders/1uy7DeAK9yu6PS9r6VbRd0boYDlvcqQb5?usp=sharing" target="_blank" rel="noopener noreferrer" class="btn-panduan">Panduan</a>
        </form>
    </div>

    <div id="app-container" class="hidden glass-card">
        <header>
            <div class="header-left">
                <img src="logo.jpg" alt="Logo MS Simpang Tiga Redelong" class="app-logo">
                <h2 id="welcome-message">Selamat Datang</h2>
            </div>
            <button id="logout-button">Logout</button>
        </header>
        
        <div id="main-content">
            <div id="pegawai-dashboard" class="hidden">
                <div class="dashboard-grid">
                    <div class="dashboard-card" id="show-pinjam-form-btn">
                        <div class="icon">&#x2B06;&#xFE0F;</div> <h3>Pinjam Barang</h3>
                        <p>Isi formulir untuk peminjaman barang baru.</p>
                    </div>
                    <div class="dashboard-card" id="show-kembali-form-btn">
                        <div class="icon">&#x2B07;&#xFE0F;</div> <h3>Kembalikan Barang</h3>
                        <p>Selesaikan proses peminjaman yang aktif.</p>
                    </div>
                </div>
            </div>

            <div id="data-view" class="hidden">
                <div id="filter-view">
                    <input type="search" id="search-input" placeholder="Cari berdasarkan nama, barang, atau ID...">
                    <div id="pengawas-features" class="hidden">
                        <a href="https://docs.google.com/spreadsheets/d/1BYucnC_skB1VApyVow9Gf-4B5WDsHTo3XQDyYJo-eNM/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="btn btn-db">Database</a>
                        <a href="https://drive.google.com/drive/folders/18QwQIrMDWje3MFPfynm4UMOcdmblzMtJ?usp=sharing" target="_blank" rel="noopener noreferrer" class="btn btn-drive">Penyimpanan Foto</a>
                        <button id="change-password-btn" class="btn btn-info">Ubah Password</button>
                        <button id="generate-pdf-btn" class="btn btn-primary">Unduh Laporan (PDF)</button>
                    </div>
                </div>
                <div id="table-view">
                    <div id="data-table-container"></div>
                    <div id="pagination-controls"></div>
                </div>
                 <div class="form-actions" style="justify-content: center;">
                    <button type="button" class="btn-back" id="back-to-menu-btn">Kembali ke Menu</button>
                </div>
            </div>
       
            <div id="peminjaman-form-view" class="hidden form-section">
                <h3>Formulir Peminjaman Barang Baru</h3>
                <form id="peminjaman-form">
                    <div class="form-grid">
                        <div class="form-group"><label for="nama-peminjam">Nama Peminjam</label><input type="text" id="nama-peminjam" required></div>
                        <div class="form-group"><label for="nama-barang">Nama Barang</label><input type="text" id="nama-barang" required></div>
                        <div class="form-group"><label for="kode-barang">Kode Barang</label><input type="text" id="kode-barang" required></div>
                        <div class="form-group"><label for="ruang-asal">Ruang Asal</label><input type="text" id="ruang-asal" required></div>
                        <div class="form-group"><label for="ruang-pindah">Ruang Pindah Sementara</label><input type="text" id="ruang-pindah" required></div>
                    </div>
                    <div class="form-grid" style="margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 25px;">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Verifikasi Wajah Peminjam</label>
                            <div class="photo-capture-area">
                                <div style="position: relative; width: 100%; max-width: 400px;">
                                <video id="wajah-feed" playsinline></video>
                                <img id="foto-wajah-preview" src="" class="hidden" alt="Pratinjau Foto Wajah">
                                </div>
                                <canvas id="wajah-canvas" class="hidden"></canvas>
                                <input type="hidden" id="foto-wajah-data">
                                <button type="button" id="capture-wajah-btn" style="background-color: var(--info-color); color: white;" disabled>Ambil Foto Wajah</button>
                                <button type="button" id="retake-wajah-btn" class="btn-back hidden">Ulangi</button>
                                <div id="face-status" class="status-badge warning">Memuat model AI...</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-grid" style="margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 25px;">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Foto Barang Saat Dipinjam</label>
                            <div class="photo-capture-area">
                                <img id="foto-pinjam-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300' viewBox='0 0 400 300'%3E%3Crect width='100%25' height='100%25' fill='rgba(0,0,0,0.1)'/%3E%3Ctext x='50%25' y='50%25' fill='%23bbbbbb' font-family='Poppins, sans-serif' font-size='20' text-anchor='middle' dominant-baseline='middle'%3EBelum Ada Foto%3C/text%3E%3C/svg%3E" alt="Pratinjau Foto Pinjam">
                                <button type="button" style="background-color: var(--info-color); color: white;" onclick="openCamera('pinjam')">Ambil Foto Barang</button>
                                <input type="hidden" id="foto-pinjam-data">
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-back">Kembali ke Menu</button>
                        <button type="submit" class="btn-submit">Simpan Peminjaman</button>
                    </div>
                </form>
            </div>

            <div id="pengembalian-form-view" class="hidden form-section">
                <h3>Formulir Pengembalian Barang</h3>
                <form id="pengembalian-form">
                    <div class="form-grid">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="select-loan-to-return">Pilih Barang yang Dikembalikan</label>
                            <select id="select-loan-to-return" required></select>
                        </div>
                        <div class="form-group">
                            <label for="return-date">Tanggal Pengembalian</label>
                            <input type="date" id="return-date" required>
                        </div>
                        <div class="form-group">
                            <label for="return-time">Waktu Pengembalian</label>
                            <input type="time" id="return-time" required>
                        </div>
                    </div>
                    <div class="form-grid" style="margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 25px;">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Foto Barang Saat Dikembalikan</label>
                            <div class="photo-capture-area">
                                <img id="foto-kembali-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300' viewBox='0 0 400 300'%3E%3Crect width='100%25' height='100%25' fill='rgba(0,0,0,0.1)'/%3E%3Ctext x='50%25' y='50%25' fill='%23bbbbbb' font-family='Poppins, sans-serif' font-size='20' text-anchor='middle' dominant-baseline='middle'%3EBelum Ada Foto%3C/text%3E%3C/svg%3E" alt="Pratinjau Foto Kembali">
                                <button type="button" style="background-color: var(--info-color); color: white;" onclick="openCamera('kembali')">Ambil Foto Pengembalian</button>
                                <input type="hidden" id="foto-kembali-data">
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-back">Kembali ke Menu</button>
                        <button type="submit" class="btn-submit">Selesaikan Pengembalian</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="camera-modal" class="hidden modal">
        <div class="modal-content">
            <h3 id="camera-modal-title">Ambil Foto Barang</h3>
            <video id="camera-feed" playsinline></video>
            <canvas id="camera-canvas" class="hidden"></canvas>
            <div class="modal-controls" style="justify-content: center;">
                <button id="capture-btn" class="btn-submit">Ambil Gambar</button>
                <button id="switch-camera-btn" class="btn-back">Ganti Kamera</button>
                <button id="cancel-camera-btn" style="background-color: var(--danger-color); color: white;">Batal</button>
            </div>
        </div>
    </div>

    <div id="password-modal" class="hidden modal">
        <div class="modal-content">
            <h3>Ubah Password</h3>
            <form id="password-form">
                <div class="form-group">
                    <label for="target-role">Ubah Password Untuk</label>
                    <select id="target-role"><option value="pegawai">Pegawai</option><option value="pengawas">Pengawas</option></select>
                </div>
                <div class="form-group">
                    <label for="new-password">Password Baru</label>
                    <input type="password" id="new-password" required>
                </div>
                <div class="modal-controls">
                    <button type="button" id="cancel-password-change" class="btn-back">Batal</button>
                    <button type="submit" class="btn-submit">Simpan</button>
                </div>
            </form>
        </div>
    </div>
        
    <div id="loader-overlay" class="hidden">
        <div class="loader-content">
            <div class="progress-bar-container"><div id="progress-bar-fill" class="progress-bar-fill"></div></div>
            <div id="progress-text">0%</div>
            <div id="progress-status-text">Mempersiapkan...</div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxW3eYLaWzF9h_LesUk1pX1GoNlllO9CES9pfDjt1RqLw4-pz5c8ECWQ2x_s9nEPRia/exec";
        const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';
        
        let state = { 
            userRole: null, password: null, allData: [], currentViewData: [],
            currentPage: 1, itemsPerPage: 8, cameraStream: null, faceCameraStream: null,
            currentFacingMode: 'environment', currentPhotoTarget: null, 
            faceApiLoaded: false, faceDetectionInterval: null
        };
        
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        const bodyEl = $('body');
        const placeholderFotoSVG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300' viewBox='0 0 400 300'%3E%3Crect width='100%25' height='100%25' fill='rgba(0,0,0,0.1)'/%3E%3Ctext x='50%25' y='50%25' fill='%23bbbbbb' font-family='Poppins, sans-serif' font-size='20' text-anchor='middle' dominant-baseline='middle'%3EBelum Ada Foto%3C/text%3E%3C/svg%3E";

        const loaderManager = {
            update(progress, statusText) {
                $('#progress-bar-fill').style.width = progress + '%';
                $('#progress-text').textContent = Math.round(progress) + '%';
                if(statusText) $('#progress-status-text').textContent = statusText;
            },
            show(initialStatus = "Mempersiapkan...") { this.update(0, initialStatus); $('#loader-overlay').classList.remove('hidden'); },
            hide() { setTimeout(() => $('#loader-overlay').classList.add('hidden'), 800); },
            finish(statusText = "Selesai!") { this.update(100, statusText); this.hide(); }
        };

        async function apiCall(action, payload = {}) {
            payload.password = state.password;
            try {
                const response = await fetch(WEB_APP_URL, { method: 'POST', mode: 'cors', redirect: 'follow', body: JSON.stringify({ action, payload }), headers: { 'Content-Type': 'text/plain;charset=utf-8' } });
                if (!response.ok) throw new Error(`Jaringan bermasalah, status: ${response.status}`);
                const result = await response.json();
                if (!result.success) throw new Error(result.message || 'Terjadi kesalahan di server.');
                return result;
            } catch (error) {
                console.error('Kesalahan Panggilan API:', error);
                loaderManager.hide();
                alert(`Error: ${error.message}`);
                return { success: false, message: error.message };
            }
        }
        
        // === PERUBAHAN JS: Logika Progress Bar Lebih Akurat ===
        async function loadFaceApiModels(startProgress, endProgress, statusText) {
            if (state.faceApiLoaded) {
                loaderManager.update(endProgress, statusText);
                return;
            };
            try {
                const totalModels = 2;
                const progressIncrement = (endProgress - startProgress) / totalModels;
                
                loaderManager.update(startProgress, statusText);
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);

                startProgress += progressIncrement;
                loaderManager.update(startProgress, statusText);
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                
                loaderManager.update(endProgress, statusText);
                state.faceApiLoaded = true;
                console.log("Model AI berhasil dimuat.");
            } catch (error) {
                console.error("Gagal memuat model AI:", error);
                if($('#face-status')) $('#face-status').textContent = "Gagal memuat model AI.";
            }
        }

        function switchView(viewToShow) {
            if (state.faceCameraStream) {
                state.faceCameraStream.getTracks().forEach(track => track.stop());
                state.faceCameraStream = null;
            }
            if (state.faceDetectionInterval) { clearInterval(state.faceDetectionInterval); state.faceDetectionInterval = null; }
            if (state.cameraStream) closeCamera();

            ['peminjaman-form-view', 'pengembalian-form-view', 'data-view', 'login-view', 'app-container', 'pegawai-dashboard'].forEach(id => $(`#${id}`)?.classList.add('hidden'));
            
            bodyEl.classList.remove('app-active', 'pegawai-active');

            if (viewToShow === 'login') {
                $('#login-view')?.classList.remove('hidden'); 
            } else {
                $('#app-container')?.classList.remove('hidden');
                
                if (state.userRole === 'pegawai') {
                    bodyEl.classList.add('pegawai-active');
                    if (viewToShow === 'app') $('#pegawai-dashboard').classList.remove('hidden');
                } else { // Pengawas & Pengunjung
                    bodyEl.classList.add('app-active');
                    if (viewToShow === 'app') $('#data-view').classList.remove('hidden');
                }
                
                if (viewToShow === 'peminjamanForm') {
                    $('#peminjaman-form-view').classList.remove('hidden');
                    $('#peminjaman-form').reset();
                    $('#foto-pinjam-preview').src = placeholderFotoSVG; $('#foto-pinjam-data').value = '';
                    resetFaceCapture();
                    initializeFaceCamera(); 
                } else if (viewToShow === 'pengembalianForm') {
                    $('#pengembalian-form-view').classList.remove('hidden');
                }
            }
        }
        
        async function initializeViewForRole(role) {
            state.userRole = role;
            loaderManager.show("Mengautentikasi...");
            await new Promise(r => setTimeout(r, 200));
            
            // Model AI dimuat dengan progress 10% -> 30%
            await loadFaceApiModels(10, 30, "Mengunduh model AI...");
            
            $('#welcome-message').textContent = `Selamat Datang, ${role.charAt(0).toUpperCase() + role.slice(1)}`;
            
            if(role === 'pegawai') {
                loaderManager.finish("Autentikasi Berhasil!");
                switchView('app');
            } else { // pengawas & pengunjung
                $('#pengawas-features').classList.toggle('hidden', role !== 'pengawas');
                loaderManager.update(35, "Menghubungi server...");
                await fetchAndRenderData(); // Fungsi ini akan menyelesaikan progress bar
                switchView('app');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const role = $('#role-selector').value;
            const password = $('#password-input').value;
            if (!role) return alert('Pilih status Anda.');
            state.password = password;

            sessionStorage.setItem('userRole', role);
            sessionStorage.setItem('password', password);
            await initializeViewForRole(role);
        }
        
        async function fetchAndRenderData(searchTerm = '') {
            const result = await apiCall('getData');
            loaderManager.update(75, "Menerima & memproses data...");
            if (result.success) {
                state.allData = result.data.sort((a,b) => {
                    const isAActive = !a['Tanggal Pengembalian']; const isBActive = !b['Tanggal Pengembalian'];
                    if (isAActive && !isBActive) return -1; if (!isAActive && isBActive) return 1;
                    const dateA = new Date(a['Tanggal']?.split('/').reverse().join('-') || 0);
                    const dateB = new Date(b['Tanggal']?.split('/').reverse().join('-') || 0);
                    return dateB - dateA;
                });
                filterAndRenderTable(searchTerm);
                loaderManager.update(90, "Menyusun tampilan...");
                await new Promise(r => setTimeout(r, 200));
                loaderManager.finish("Data berhasil dimuat!");
            }
        }
        
        function filterAndRenderTable(searchTerm = '') {
            const lowercasedFilter = searchTerm.toLowerCase();
            const filteredData = state.allData.filter(row => {
                return Object.values(row).some(value => 
                    String(value).toLowerCase().includes(lowercasedFilter)
                );
            });
            state.currentViewData = filteredData;
            state.currentPage = 1;
            renderTable();
            setupPagination();
        }

        function renderTable() {
            const container = $('#data-table-container');
            const startIndex = (state.currentPage - 1) * state.itemsPerPage;
            const endIndex = startIndex + state.itemsPerPage;
            const pageData = state.currentViewData.slice(startIndex, endIndex);
            if (pageData.length === 0) {
                container.innerHTML = `<p style="text-align:center; color: white; padding: 40px;">Tidak ada data untuk ditampilkan.</p>`;
                return;
            }
            const allHeaders = Object.keys(state.allData[0] || {}); let headers = allHeaders;
            if (state.userRole === 'pengunjung') { headers = allHeaders.filter(h => !h.toLowerCase().includes('password')); }
            const tableHTML = `<table><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>
                ${pageData.map(row => `<tr data-id="${row.ID}">${headers.map(header => {
                    let value = row[header];
                    
                    // === PERUBAHAN JS: Menghapus 00:00:00 dari Tanggal ===
                    const isDateField = header === 'Tanggal' || header === 'Tanggal Pengembalian';
                    if (isDateField && value && typeof value === 'string') {
                        value = value.split(' ')[0];
                    }

                    if (header.toLowerCase().includes('foto')) { return `<td>${value ? `<img src="${value}" class="table-photo" alt="Foto">` : ''}</td>`; }
                    if (header === 'Penilaian Pengawas' && state.userRole === 'pengawas') { return `<td><select class="rating-select" data-id="${row.ID}"><option value="">-- Beri Nilai --</option><option value="Baik" ${value==='Baik'?'selected':''}>Baik</option><option value="Kurang Baik" ${value==='Kurang Baik'?'selected':''}>Kurang Baik</option></select></td>`; }
                    
                    // === PERUBAHAN JS: Memperbaiki Struktur HTML untuk Kolom ID ===
                    if (header === 'ID') {
                        let actionsHTML = '';
                        if (state.userRole === 'pengawas') {
                            actionsHTML += `<button class="btn-delete" data-id="${row.ID}">Hapus</button>`;
                        }
                        // Struktur baru: Class "actions" hanya pada div, bukan <td>
                        return `<td style="white-space: normal;">
                                    ${value}
                                    <div class="actions">${actionsHTML}</div>
                                </td>`;
                    }
                    return `<td style="white-space: normal; max-width: 200px;">${value || '-'}</td>`;
                }).join('')}</tr>`).join('')}</tbody></table>`;
            container.innerHTML = tableHTML;
        }
        
        function setupPagination() {
            const container = $('#pagination-controls'); const pageCount = Math.ceil(state.currentViewData.length / state.itemsPerPage);
            container.innerHTML = ''; if (pageCount <= 1) return;
            for (let i = 1; i <= pageCount; i++) {
                const btn = document.createElement('button'); btn.textContent = i;
                btn.className = 'pagination-btn' + (i === state.currentPage ? ' active' : '');
                btn.onclick = () => { state.currentPage = i; renderTable(); setupPagination(); };
                container.appendChild(btn);
            }
        }
        
        async function initializeFaceCamera() {
            const videoEl = $('#wajah-feed'), faceStatus = $('#face-status');
            if (!state.faceApiLoaded) {
                faceStatus.textContent = "Menunggu model AI..."; 
                // Memuat model AI tanpa progress bar karena ini di dalam form
                await loadFaceApiModels(0, 0, ""); 
            }
            try {
                if (state.faceCameraStream) state.faceCameraStream.getTracks().forEach(t => t.stop());
                state.faceCameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                videoEl.srcObject = state.faceCameraStream;
                videoEl.onloadedmetadata = () => { videoEl.play(); startFaceDetection(); }
            } catch (err) {
                console.error("Gagal akses kamera wajah:", err);
                faceStatus.textContent = "Kamera tidak dapat diakses."; faceStatus.className = 'status-badge error';
            }
        }

        function startFaceDetection() {
            const videoEl = $('#wajah-feed'), captureBtn = $('#capture-wajah-btn'), faceStatus = $('#face-status');
            if(state.faceDetectionInterval) clearInterval(state.faceDetectionInterval);
            state.faceDetectionInterval = setInterval(async () => {
                const detections = await faceapi.detectAllFaces(videoEl, new faceapi.TinyFaceDetectorOptions());
                if (detections.length > 0) {
                    captureBtn.disabled = false;
                    faceStatus.textContent = "Wajah Terdeteksi. Siap ambil foto."; faceStatus.className = 'status-badge success';
                } else {
                    captureBtn.disabled = true;
                    faceStatus.textContent = "Posisikan Wajah di Depan Kamera."; faceStatus.className = 'status-badge error';
                }
            }, 800);
        }
        async function captureFacePhoto() {
            const videoEl = $('#wajah-feed'), canvasEl = $('#wajah-canvas'), previewEl = $('#foto-wajah-preview'), dataInput = $('#foto-wajah-data');
            const detections = await faceapi.detectAllFaces(videoEl, new faceapi.TinyFaceDetectorOptions());
            if (detections.length === 0) return alert('Wajah tidak terdeteksi. Coba lagi.');
            if(state.faceDetectionInterval) clearInterval(state.faceDetectionInterval);
            const context = canvasEl.getContext('2d');
            canvasEl.width = videoEl.videoWidth; canvasEl.height = videoEl.videoHeight;
            context.translate(canvasEl.width, 0); context.scale(-1, 1);
            context.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);
            const dataUrl = canvasEl.toDataURL('image/jpeg', 0.8);
            dataInput.value = dataUrl.split(',')[1]; previewEl.src = dataUrl;
            videoEl.classList.add('hidden'); previewEl.classList.remove('hidden');
            $('#capture-wajah-btn').classList.add('hidden'); $('#retake-wajah-btn').classList.remove('hidden');
            if (state.faceCameraStream) { state.faceCameraStream.getTracks().forEach(track => track.stop()); state.faceCameraStream = null; }
        }
        function resetFaceCapture() {
            const videoEl = $('#wajah-feed'), previewEl = $('#foto-wajah-preview'), dataInput = $('#foto-wajah-data'), faceStatus = $('#face-status');
            dataInput.value = ''; previewEl.src = '';
            videoEl.classList.remove('hidden'); previewEl.classList.add('hidden');
            $('#capture-wajah-btn').classList.remove('hidden'); $('#retake-wajah-btn').classList.add('hidden');
            $('#capture-wajah-btn').disabled = true;
            faceStatus.className = 'status-badge warning'; faceStatus.textContent = "Memulai kamera...";
            initializeFaceCamera();
        }

        async function startCameraStream(facingMode) {
            if (state.cameraStream) state.cameraStream.getTracks().forEach(track => track.stop());
            state.cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: facingMode } });
            $('#camera-feed').srcObject = state.cameraStream;
            $('#camera-feed').play();
        }
        async function openCamera(target) {
            state.currentPhotoTarget = target;
            $('#camera-modal-title').textContent = target === 'pinjam' ? 'Ambil Foto Barang Saat Dipinjam' : 'Ambil Foto Barang Saat Dikembalikan';
            $('#camera-modal').classList.remove('hidden');
            try { await startCameraStream(state.currentFacingMode); } 
            catch (e) { alert('Gagal mengakses kamera. Pastikan Anda memberikan izin.'); closeCamera(); }
        }
        function closeCamera() {
            if (state.cameraStream) state.cameraStream.getTracks().forEach(track => track.stop());
            $('#camera-modal').classList.add('hidden');
        }
        function capturePhoto() {
            const video = $('#camera-feed'), canvas = $('#camera-canvas');
            const previewId = state.currentPhotoTarget === 'pinjam' ? '#foto-pinjam-preview' : '#foto-kembali-preview';
            const dataId = state.currentPhotoTarget === 'pinjam' ? '#foto-pinjam-data' : '#foto-kembali-data';
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            if (state.currentFacingMode === 'user') { context.translate(canvas.width, 0); context.scale(-1, 1); }
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
            $(previewId).src = dataUrl; $(dataId).value = dataUrl.split(',')[1];
            closeCamera();
        }
        
        async function handlePinjamSubmit(e) {
            e.preventDefault();
            const photoBarangData = $('#foto-pinjam-data').value;
            const photoWajahData = $('#foto-wajah-data').value;
            if (!photoWajahData) return alert('Verifikasi wajah wajib dilakukan.');
            if (!photoBarangData) return alert('Foto barang wajib diambil.');
            
            loaderManager.show("Memvalidasi data...");
            await new Promise(r => setTimeout(r, 200));
            loaderManager.update(20, "Mempersiapkan gambar...");
            const payload = {
                Nama: $('#nama-peminjam').value.trim(), NamaBarang: $('#nama-barang').value.trim(),
                KodeBarang: $('#kode-barang').value.trim(), RuangAsal: $('#ruang-asal').value.trim(),
                RuangPindah: $('#ruang-pindah').value.trim(), FotoPinjamBase64: photoBarangData,
                FotoWajahBase64: photoWajahData,
            };
            await new Promise(r => setTimeout(r, 300));
            loaderManager.update(40, "Mengirim data ke server...");
            const result = await apiCall('recordLoanWithPhoto', payload);
            if (result.success) { 
                loaderManager.update(90, "Menunggu konfirmasi akhir...");
                await new Promise(r => setTimeout(r, 300));
                loaderManager.finish('Data berhasil disimpan!');
                alert('Data peminjaman berhasil disimpan!');
                switchView('app');
            }
        }
        
        async function populateReturnDropdown(data) {
            const selectEl = $('#select-loan-to-return');
            selectEl.innerHTML = '<option value="">-- Pilih Barang yang Akan Dikembalikan --</option>';
            const activeLoans = data.filter(item => !item['Tanggal Pengembalian']);
            if(activeLoans.length === 0){
                selectEl.innerHTML = '<option value="" disabled>Tidak ada barang yang sedang dipinjam</option>'; return;
            }
            activeLoans.forEach(loan => {
                const option = document.createElement('option');
                option.value = loan.ID;
                option.textContent = `${loan['Nama Barang']} (Oleh: ${loan.Nama})`;
                selectEl.appendChild(option);
            });
        }
        
        async function handleReturnSubmit(e) {
            e.preventDefault();
            const loanId = $('#select-loan-to-return').value;
            if (!loanId) return alert('Pilih barang yang akan dikembalikan terlebih dahulu.');
            const photoKembaliData = $('#foto-kembali-data').value;
            if (!photoKembaliData) return alert('Foto barang saat pengembalian wajib diambil.');
            
            loaderManager.show("Mempersiapkan data...");
            await new Promise(r => setTimeout(r, 200));
            loaderManager.update(30, "Mengirim data pengembalian...");
            const payload = {
                loanId: loanId, FotoKembaliBase64: photoKembaliData,
                tanggalKembali: $('#return-date').value, waktuKembali: $('#return-time').value,
            };
            const result = await apiCall('completeReturnWithPhoto', payload);
            if (result.success) {
                loaderManager.update(90, "Menunggu konfirmasi akhir...");
                await new Promise(r => setTimeout(r, 300));
                loaderManager.finish('Barang berhasil dikembalikan!');
                alert('Barang berhasil dikembalikan!');
                switchView('app');
            }
        }
        
        async function handleDelete(loanId) {
            if (confirm(`Yakin ingin menghapus data peminjaman dengan ID: ${loanId}?`)) {
                loaderManager.show("Mengirim permintaan hapus...");
                const result = await apiCall('deleteLoan', { loanId });
                if (result.success) {
                    loaderManager.update(50, "Memuat ulang data terbaru...");
                    await fetchAndRenderData($('#search-input').value);
                }
            }
        }

        async function handleRatingChange(loanId, rating) {
            const selectEl = $(`select.rating-select[data-id="${loanId}"]`);
            selectEl.classList.add('rating-saving');
            const result = await apiCall('setRating', { loanId, rating });
            selectEl.classList.remove('rating-saving');
            selectEl.classList.add(result.success ? 'rating-success' : 'rating-error');
            setTimeout(() => selectEl.classList.remove('rating-success', 'rating-error'), 2000);
        }
        
        async function handleChangePassword(e) {
            e.preventDefault();
            const targetRole = $('#target-role').value;
            const newPassword = $('#new-password').value;
            if (confirm(`Yakin ingin mengubah password untuk ${targetRole}?`)) {
                loaderManager.show("Menyimpan password baru...");
                const result = await apiCall('changePassword', { targetRole, newPassword });
                if (result.success) {
                    $('#password-modal').classList.add('hidden');
                    loaderManager.finish("Password berhasil diubah!");
                    alert("Password berhasil diubah!");
                }
            }
        }

        async function handleGeneratePdf() {
            loaderManager.show("Membuat file PDF...");
            loaderManager.update(20, "Mengumpulkan data...");
            const result = await apiCall('generatePdf');
            if (result.success) {
                loaderManager.update(70, "Mengonversi ke PDF...");
                const byteCharacters = atob(result.pdfData);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) { byteNumbers[i] = byteCharacters.charCodeAt(i); }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], {type: 'application/pdf'});
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = result.fileName || 'laporan.pdf';
                link.click();
                loaderManager.finish("PDF siap diunduh!");
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const sessionRole = sessionStorage.getItem('userRole');
            if (sessionRole) { state.password = sessionStorage.getItem('password'); initializeViewForRole(sessionRole); } 
            else { switchView('login'); }
            $('#login-form').addEventListener('submit', handleLogin);
            $('#logout-button').addEventListener('click', () => { sessionStorage.clear(); window.location.reload(); });
            $('#role-selector').addEventListener('change', e => $('#password-input').classList.toggle('hidden', !['pegawai', 'pengawas'].includes(e.target.value)));
            $('#show-pinjam-form-btn').addEventListener('click', () => switchView('peminjamanForm'));
            $('#show-kembali-form-btn').addEventListener('click', async () => {
                loaderManager.show("Memuat data aktif...");
                const result = await apiCall('getData');
                loaderManager.update(70, "Menyusun daftar barang...");
                if(result.success) populateReturnDropdown(result.data);
                switchView('pengembalianForm');
                loaderManager.finish("Silakan pilih barang.");
            });
            $('#back-to-menu-btn').addEventListener('click', () => switchView('app'));
            $('#peminjaman-form').addEventListener('submit', handlePinjamSubmit);
            $('#pengembalian-form').addEventListener('submit', handleReturnSubmit);
            $$('.btn-back').forEach(btn => btn.addEventListener('click', () => switchView('app')));
            $('#capture-wajah-btn').addEventListener('click', captureFacePhoto);
            $('#retake-wajah-btn').addEventListener('click', resetFaceCapture);
            $('#capture-btn').addEventListener('click', capturePhoto);
            $('#cancel-camera-btn').addEventListener('click', closeCamera);
            $('#switch-camera-btn').addEventListener('click', async () => { state.currentFacingMode = state.currentFacingMode === 'environment' ? 'user' : 'environment'; await startCameraStream(state.currentFacingMode); });
            $('#search-input').addEventListener('input', e => filterAndRenderTable(e.target.value));
            $('#data-table-container').addEventListener('click', e => { if (e.target.matches('.btn-delete')) handleDelete(e.target.dataset.id); });
            $('#data-table-container').addEventListener('change', e => { if (e.target.matches('.rating-select')) handleRatingChange(e.target.dataset.id, e.target.value); });
            $('#change-password-btn').addEventListener('click', () => $('#password-modal').classList.remove('hidden'));
            $('#password-form').addEventListener('submit', handleChangePassword);
            $('#cancel-password-change').addEventListener('click', () => $('#password-modal').classList.add('hidden'));
            $('#generate-pdf-btn').addEventListener('click', handleGeneratePdf);
        });
    </script>
</body>
</html>
